# Yield Optimization Agent

An AI-powered agent that helps users find the best and safest staking opportunities for their tokens across multiple DeFi protocols and chains.

## Features

- üîç **Token Discovery**: Search tokens by name, symbol, or contract address
- üåê **Multi-Chain Support**: Ethereum, Arbitrum, Optimism, Polygon, Base, Avalanche, BNB Chain
- üè¶ **Protocol Discovery**: Automatically find all available staking protocols for any token
- üõ°Ô∏è **Safety Evaluation**: Comprehensive safety scoring based on TVL, reputation, audits, and history
- üí∞ **Transaction Generation**: Generate approval and deposit transactions using Enso SDK
- ‚ö†Ô∏è **Safety First**: Mandatory safety warnings and comprehensive validation

## Installation

```bash
# Install dependencies
yarn install

# Or with npm
npm install
```

## Configuration

Create a `.env` file in the root directory:

```env
# Required
OPENAI_API_KEY=your_openai_api_key
ENSO_API_KEY=your_enso_api_key

# Optional but recommended
COINGECKO_API_KEY=your_coingecko_api_key
```

## Usage

### Basic Usage

```typescript
import { runYieldAgent } from './src';

const questions = [
  'Find staking opportunities for USDC',
  'What protocols can I stake ETH on Arbitrum?',
];

const results = await runYieldAgent(questions);
```

### Interactive Mode

The agent guides users through a step-by-step process:

1. **Token Input**: User provides token name or address
2. **Token Confirmation**: Agent fetches and displays token information
3. **Protocol Discovery**: Agent finds all available protocols across chains
4. **Safety Evaluation**: Protocols are ranked by safety and yield
5. **Protocol Selection**: User selects preferred protocol
6. **Transaction Generation**: Agent creates transaction bundle (approval + deposit if needed)

### Quick Mode

Users can provide all information in one command:

```
"Deposit 100 USDC on Arbitrum to Aave v3"
```

The agent will:
- Parse all inputs
- Validate everything
- Generate transaction bundle immediately
- Include all safety warnings

## API Reference

### Core Functions

#### `runYieldAgent(questions, options)`

Run the yield optimization agent with a list of questions.

**Parameters:**
- `questions: string[]` - Array of user questions
- `options?: AgentOptions` - Optional configuration

**Returns:** `Promise<AgentResponse[]>`

**Example:**
```typescript
const results = await runYieldAgent([
  'Find staking for USDC on Arbitrum'
], {
  modelName: 'gpt-4o-mini',
  temperature: 0
});
```

### Services

#### Token Info API (`src/agent/api.ts`)

- `getTokenInfo(input, chainId?, chainName?)` - Get token information
- `searchToken(query)` - Search tokens by name/symbol
- `getTokenByAddress(address, chainId)` - Get token by contract address

#### Enso Service (`src/agent/enso-service.ts`)

- `discoverProtocols(tokenAddress, chainId)` - Find protocols on a chain
- `discoverProtocolsMultiChain(tokenAddress)` - Find protocols across all chains
- `checkApprovalNeeded(...)` - Check if token approval is needed
- `generateTransactionBundle(...)` - Generate approval + deposit transactions

#### Safety Service (`src/agent/safety-service.ts`)

- `evaluateProtocolSafety(protocol)` - Evaluate protocol safety score
- `addSafetyScores(protocols)` - Add safety scores to protocols
- `sortProtocolsBySafetyAndYield(protocols)` - Sort protocols by safety and yield

#### Validation (`src/agent/validation.ts`)

- `validateTokenInput(input)` - Validate token input
- `validateChain(chain)` - Validate chain
- `validateAmount(amount, balance, decimals)` - Validate amount
- `detectQuickMode(input)` - Detect quick mode input
- `parseQuickModeInput(input)` - Parse quick mode input

## Safety Features

### Mandatory Safety Warnings

All transaction objects include this warning:

```
‚ö†Ô∏è CRITICAL: This transaction object was generated by an AI agent.
Please verify all details (token address, protocol address, amount, chain)
before executing. Double-check on block explorer and protocol website.
This is not financial advice.
```

### Input Validation

- **Address Validation**: Validates Ethereum address format and checksum
- **Chain Validation**: Ensures chain is supported
- **Amount Validation**: Verifies amount is positive and within balance
- **Address + Chain Requirement**: When address is provided, chain MUST be specified

### Pre-Transaction Checks

Before generating any transaction, the agent verifies:
- Token exists on specified chain
- Protocol exists for token on chain
- User has sufficient balance
- Protocol safety evaluation
- All parameters are valid

## Supported Chains

- Ethereum (Chain ID: 1)
- Arbitrum (Chain ID: 42161)
- Optimism (Chain ID: 10)
- Polygon (Chain ID: 137)
- Base (Chain ID: 8453)
- Avalanche (Chain ID: 43114)
- BNB Chain (Chain ID: 56)

## Safety Scoring

Protocols are evaluated based on:

1. **TVL (Total Value Locked)**
   - > $100M: Very Safe
   - $10M - $100M: Safe
   - < $10M: Risky

2. **Protocol Reputation**
   - Trusted protocols (Aave, Compound, Lido, etc.)
   - Unknown protocols flagged

3. **Audit Status**
   - Verified audits from DefiLlama
   - Audit count and quality

4. **Historical Performance**
   - Protocol age and stability
   - Security incident history

## Transaction Flow

### With Approval Needed

1. Generate approval transaction
2. User executes approval transaction
3. Wait for confirmation
4. Generate deposit transaction
5. User executes deposit transaction

### Without Approval Needed

1. Generate deposit transaction
2. User executes deposit transaction

## Error Handling

The agent handles various error cases:

- Token not found
- No protocols available
- Invalid address format
- Unsupported chain
- Insufficient balance
- Network errors
- API rate limiting

All errors include clear messages and suggestions.

## Development

### Project Structure

```
yield-agent/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ agent/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Main agent orchestration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools.ts               # LangChain tools
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts                 # CoinGecko integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enso-service.ts        # Enso SDK wrapper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ safety-service.ts     # Safety evaluation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.ts          # Input validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts               # TypeScript types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ output-structure.ts   # Response schema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ system-prompt.ts       # Agent system prompt
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                  # Public API
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

### Building

```bash
# Build TypeScript
yarn build

# Run linter
yarn lint

# Format code
yarn prettier
```

### Testing

```bash
# Run tests
yarn test
```

## Dependencies

- **LangGraph**: Agent framework
- **Enso SDK**: Protocol discovery and transaction generation
- **CoinGecko API**: Token information
- **viem**: Ethereum utilities
- **Zod**: Schema validation

## Important Notes

‚ö†Ô∏è **CRITICAL SAFETY REMINDERS:**

1. **Always verify transaction details** before executing
2. **Check token addresses** on block explorer
3. **Verify protocol addresses** on protocol website
4. **Review safety scores** before selecting protocols
5. **Start with small amounts** when trying new protocols
6. **This is not financial advice** - do your own research



